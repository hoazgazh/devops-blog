---
title: "Centralizing WAF Logs for Multiple AWS Accounts"
seoTitle: "AWS WAF: Centralized Log Across Accounts"
seoDescription: "Set up centralized logging for AWS WAF using Terraform to send logs from workload accounts to a security account's S3 bucket"
datePublished: Mon Dec 23 2024 06:53:20 GMT+0000 (Coordinated Universal Time)
cuid: cm50okr86000c08l61z0mh6q0
slug: centralizing-waf-logs-for-multiple-aws-accounts

---

Dưới đây là hướng dẫn hoàn chỉnh để **cấu hình AWS Firewall Manager (FMS)** và **AWS WAF** từ **tài khoản tập trung (security-account)** nhằm gửi log WAF từ **các tài khoản workload** đến một **Amazon S3 bucket** trong **security-account** hoàn toàn bằng **Terraform**.

### **1\. Tổng Quan**

* **Tài khoản tập trung (security-account):**
    
    * Tạo **S3 bucket** để lưu trữ log WAF.
        
    * Thiết lập **policy bucket** để cho phép các tài khoản workload ghi log.
        
    * (Tùy chọn) Thiết lập **mã hóa với AWS KMS**.
        
    * Tạo và quản lý **FMS Policy** để cấu hình logging cho AWS WAF trong các tài khoản workload.
        
* **Tài khoản workload:**
    
    * **Không cần thực hiện bất kỳ cấu hình nào**, vì mọi thứ được quản lý từ **security-account** thông qua FMS.
        

### **2\. Cấu Trúc Repository**

Bạn sẽ có **một repository duy nhất** cho **security-account**, bao gồm các file Terraform sau:

```
security-account/
├── main.tf
├── variables.tf
├── outputs.tf
└── terraform.tfvars
```

### **3\. Chi Tiết Cấu Hình Terraform**

#### **3.1. File** [`variables.tf`](http://variables.tf)

Định nghĩa các biến cần thiết để cấu hình linh hoạt.

```hcl
# security-account/variables.tf

variable "region" {
  description = "AWS Region"
  type        = string
  default     = "ap-southeast-1"
}

variable "waf_logs_bucket_name" {
  description = "Tên S3 bucket để lưu trữ AWS WAF logs"
  type        = string
}

variable "workload_account_ids" {
  description = "Danh sách Account IDs của các tài khoản workload"
  type        = list(string)
}

variable "fms_policy_name" {
  description = "Tên của FMS Policy"
  type        = string
  default     = "CentralizedWAFLoggingPolicy"
}

variable "fms_policy_orgunit_list" {
  description = "Danh sách Organizational Units mà FMS Policy áp dụng"
  type        = list(string)
}

variable "fms_policy_remediation_enabled" {
  description = "Bật/Tắt remediation cho FMS Policy"
  type        = bool
  default     = true
}

variable "fms_policy_default_action" {
  description = "Hành động mặc định của FMS Policy"
  type        = string
  default     = "BLOCK" # Hoặc "ALLOW"
}

variable "fms_policy_exclude_resource_tags" {
  description = "Danh sách các tags để loại trừ trong FMS Policy"
  type        = map(string)
  default     = {}
}

variable "fms_policy_resource_tags" {
  description = "Tags áp dụng cho FMS Policy"
  type        = map(string)
  default     = {}
}

variable "enable_kms_encryption" {
  description = "Bật/Tắt mã hóa với KMS cho S3 bucket"
  type        = bool
  default     = false
}
```

#### **3.2. File** [`main.tf`](http://main.tf)

Chứa các tài nguyên chính cần thiết cho việc cấu hình.

```hcl
# security-account/main.tf

provider "aws" {
  alias  = "security"
  region = var.region
}

data "aws_caller_identity" "current" {}

# Tạo S3 Bucket để lưu trữ WAF logs
resource "aws_s3_bucket" "waf_logs_bucket" {
  provider = aws.security
  bucket   = var.waf_logs_bucket_name
  acl      = "private"

  tags = {
    Name        = "AWS WAF Logs Centralized Bucket"
    Environment = "Security"
  }
}

# policy bucket để cho phép AWS WAF từ các tài khoản workload ghi log
resource "aws_s3_bucket_policy" "waf_logs_bucket_policy" {
  provider = aws.security
  bucket   = aws_s3_bucket.waf_logs_bucket.id

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "AWSLogDeliveryWrite",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = "s3:PutObject",
        Resource = "${aws_s3_bucket.waf_logs_bucket.arn}/AWSLogs/*",
        Condition = {
          StringEquals = {
            "s3:x-amz-acl"      = "bucket-owner-full-control",
            "aws:SourceAccount" = var.workload_account_ids
          },
          ArnLike = {
            "aws:SourceArn" = [
              for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
            ]
          }
        }
      },
      {
        Sid       = "AWSLogDeliveryAclCheck",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = "s3:GetBucketAcl",
        Resource = aws_s3_bucket.waf_logs_bucket.arn,
        Condition = {
          StringEquals = {
            "aws:SourceAccount" = var.workload_account_ids
          },
          ArnLike = {
            "aws:SourceArn" = [
              for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
            ]
          }
        }
      }
    ]
  })
}

# (Tùy chọn) Tạo KMS Key để mã hóa log
resource "aws_kms_key" "waf_logs_key" {
  provider = aws.security
  description             = "KMS key for encrypting AWS WAF logs"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "Allow administration of the key",
        Effect    = "Allow",
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        },
        Action   = [
          "kms:Create*",
          "kms:Describe*",
          "kms:Enable*",
          "kms:List*",
          "kms:Put*",
          "kms:Update*",
          "kms:Revoke*",
          "kms:Disable*",
          "kms:Get*",
          "kms:Delete*",
          "kms:TagResource",
          "kms:UntagResource",
          "kms:ScheduleKeyDeletion",
          "kms:CancelKeyDeletion"
        ],
        Resource = "*"
      },
      {
        Sid       = "Allow AWS WAF to use the key",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = [
          "kms:GenerateDataKey*",
          "kms:Decrypt"
        ],
        Resource = "*"
      }
    ]
  })
}

# Cấu hình mã hóa cho S3 bucket (nếu bật KMS encryption)
resource "aws_s3_bucket_server_side_encryption_configuration" "waf_logs_sse" {
  provider = aws.security
  bucket   = aws_s3_bucket.waf_logs_bucket.id

  dynamic "rule" {
    for_each = var.enable_kms_encryption ? [1] : []
    content {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.waf_logs_key.arn
      }
    }
  }
}

# Tạo FMS Policy để cấu hình logging cho WAF trong các tài khoản workload
resource "aws_fms_policy" "waf_logging_policy" {
  provider              = aws.security
  name                  = var.fms_policy_name
  include_map {
    orgunit = var.fms_policy_orgunit_list
  }
  remediation_enabled   = var.fms_policy_remediation_enabled
  resource_type_list    = ["AWS::WAFv2::WebACL"]
  exclude_resource_tags = var.fms_policy_exclude_resource_tags

  security_service_policy_data {
    type = "WAFV2"

    managed_service_data = jsonencode({
      type = "WAFV2",
      default_action = {
        type = var.fms_policy_default_action
      },
      rule_groups = [],
      logging_configuration = {
        log_destination_configs = var.enable_kms_encryption ? [aws_s3_bucket.waf_logs_bucket.arn] : [aws_s3_bucket.waf_logs_bucket.arn]
      },
      preProcessRuleGroups = [],
      postProcessRuleGroups = []
    })
  }

  # Tagging (nếu cần)
  resource_tags = length(var.fms_policy_resource_tags) == 0 ? null : var.fms_policy_resource_tags
}

# (Nếu bạn sử dụng AWS KMS để mã hóa log, tạo alias cho KMS key
resource "aws_kms_alias" "waf_logs_key_alias" {
  provider = aws.security
  name     = "alias/waf-logs-key"
  target_key_id = aws_kms_key.waf_logs_key.id

  count = var.enable_kms_encryption ? 1 : 0
}
```

#### **Giải Thích Chi Tiết Từng Phần Code**

##### **3.2.1. Provider Configuration**

```hcl
provider "aws" {
  alias  = "security"
  region = var.region
}
```

* `provider "aws"`: Định nghĩa provider AWS với alias `security`.
    
* `region = var.region`: Sử dụng biến `region` để xác định vùng AWS.
    

##### **3.2.2. Data Source**

```bash
data "aws_caller_identity" "current" {}
```

* `data "aws_caller_identity" "current"`: Lấy thông tin về tài khoản AWS hiện tại (security-account).
    

##### **3.2.3. Tạo S3 Bucket**

```bash
resource "aws_s3_bucket" "waf_logs_bucket" {
  provider = aws.security
  bucket   = var.waf_logs_bucket_name
  acl      = "private"

  tags = {
    Name        = "AWS WAF Logs Centralized Bucket"
    Environment = "Security"
  }
}
```

* `resource "aws_s3_bucket" "waf_logs_bucket"`: Tạo một S3 bucket để lưu trữ log WAF.
    
* `provider =` [`aws.security`](http://aws.security): Sử dụng provider AWS với alias `security`.
    
* `bucket = var.waf_logs_bucket_name`: Tên bucket được lấy từ biến `waf_logs_bucket_name`.
    
* `acl = "private"`: Thiết lập quyền truy cập bucket là riêng tư.
    
* `tags`: Thêm thẻ cho bucket để dễ quản lý và nhận diện.
    

##### **3.2.4. Thiết Lập Policy Bucket**

```bash
resource "aws_s3_bucket_policy" "waf_logs_bucket_policy" {
  provider = aws.security
  bucket   = aws_s3_bucket.waf_logs_bucket.id

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "AWSLogDeliveryWrite",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = "s3:PutObject",
        Resource = "${aws_s3_bucket.waf_logs_bucket.arn}/AWSLogs/*",
        Condition = {
          StringEquals = {
            "s3:x-amz-acl"      = "bucket-owner-full-control",
            "aws:SourceAccount" = var.workload_account_ids
          },
          ArnLike = {
            "aws:SourceArn" = [
              for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
            ]
          }
        }
      },
      {
        Sid       = "AWSLogDeliveryAclCheck",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = "s3:GetBucketAcl",
        Resource = aws_s3_bucket.waf_logs_bucket.arn,
        Condition = {
          StringEquals = {
            "aws:SourceAccount" = var.workload_account_ids
          },
          ArnLike = {
            "aws:SourceArn" = [
              for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
            ]
          }
        }
      }
    ]
  })
}
```

* `resource "aws_s3_bucket_policy" "waf_logs_bucket_policy"`: Thiết lập **policy** bucket để cho phép các tài khoản workload ghi log.
    
* `policy = jsonencode({...})`: Chuyển đổi cấu hình **policy** từ HCL sang JSON.
    

**Chi Tiết policy:**

1. **Statement 1: AWSLogDeliveryWrite**
    
    * `Sid`: Tên định danh cho statement này.
        
    * `Effect`: Cho phép (`Allow`).
        
    * `Principal`: Dịch vụ [`delivery.logs.amazonaws.com`](http://delivery.logs.amazonaws.com) có quyền.
        
    * `Action`: Cho phép hành động `s3:PutObject` để ghi log vào bucket.
        
    * `Resource`: Xác định bucket và thư mục nơi log sẽ được ghi (`aws-waf-logs-centralized/AWSLogs/*`).
        
    * `Condition`:
        
        * `StringEquals`:
            
            * `s3:x-amz-acl`: Yêu cầu quyền sở hữu đầy đủ cho bucket owner.
                
            * `aws:SourceAccount`: Chỉ cho phép các tài khoản workload (`var.workload_account_ids`).
                
        * `ArnLike`:
            
            * `aws:SourceArn`: Chỉ cho phép các log từ các tài khoản workload trong vùng được chỉ định.
                
2. **Statement 2: AWSLogDeliveryAclCheck**
    
    * `Sid`: Tên định danh cho statement này.
        
    * `Effect`: Cho phép (`Allow`).
        
    * `Principal`: Dịch vụ [`delivery.logs.amazonaws.com`](http://delivery.logs.amazonaws.com) có quyền.
        
    * `Action`: Cho phép hành động `s3:GetBucketAcl` để kiểm tra ACL của bucket.
        
    * `Resource`: Xác định bucket (`aws-waf-logs-centralized`).
        
    * `Condition`:
        
        * `StringEquals`:
            
            * `aws:SourceAccount`: Chỉ cho phép các tài khoản workload (`var.workload_account_ids`).
                
        * `ArnLike`:
            
            * `aws:SourceArn`: Chỉ cho phép các log từ các tài khoản workload trong vùng được chỉ định.
                

##### **3.2.5. Tạo KMS Key (Optional)**

```bash
resource "aws_kms_key" "waf_logs_key" {
  provider = aws.security
  description             = "KMS key for encrypting AWS WAF logs"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "Allow administration of the key",
        Effect    = "Allow",
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        },
        Action   = [
          "kms:Create*",
          "kms:Describe*",
          "kms:Enable*",
          "kms:List*",
          "kms:Put*",
          "kms:Update*",
          "kms:Revoke*",
          "kms:Disable*",
          "kms:Get*",
          "kms:Delete*",
          "kms:TagResource",
          "kms:UntagResource",
          "kms:ScheduleKeyDeletion",
          "kms:CancelKeyDeletion"
        ],
        Resource = "*"
      },
      {
        Sid       = "Allow AWS WAF to use the key",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = [
          "kms:GenerateDataKey*",
          "kms:Decrypt"
        ],
        Resource = "*"
      }
    ]
  })
}
```

* `resource "aws_kms_key" "waf_logs_key"`: Tạo một KMS key để mã hóa log WAF.
    
* `description`: Mô tả về key.
    
* `deletion_window_in_days`: Thời gian chờ trước khi key bị xóa.
    
* `enable_key_rotation`: Bật xoay key hàng năm.
    
* `policy`: Policy key:
    
    * **Statement 1: Allow administration of the key**
        
        * `Principal`: Root user của security-account.
            
        * `Action`: Cho phép các hành động quản trị key.
            
    * **Statement 2: Allow AWS WAF to use the key**
        
        * `Principal`: Dịch vụ [`delivery.logs.amazonaws.com`](http://delivery.logs.amazonaws.com) có quyền.
            
        * `Action`: Cho phép hành động `kms:GenerateDataKey*` và `kms:Decrypt` để AWS WAF có thể mã hóa log.
            

##### **3.2.6. Cấu Hình Mã Hóa Cho S3 Bucket**

```bash
resource "aws_s3_bucket_server_side_encryption_configuration" "waf_logs_sse" {
  provider = aws.security
  bucket   = aws_s3_bucket.waf_logs_bucket.id

  dynamic "rule" {
    for_each = var.enable_kms_encryption ? [1] : []
    content {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.waf_logs_key.arn
      }
    }
  }
}
```

* `resource "aws_s3_bucket_server_side_encryption_configuration" "waf_logs_sse"`: Thiết lập mã hóa phía server cho S3 bucket.
    
* `dynamic "rule"`: Sử dụng dynamic block để chỉ thêm cấu hình mã hóa nếu `enable_kms_encryption` được bật.
    
    * `for_each = var.enable_kms_encryption ? [1] : []`: Nếu `enable_kms_encryption` là `true`, thêm rule; ngược lại, không thêm gì cả.
        
    * `apply_server_side_encryption_by_default`:
        
        * `sse_algorithm = "aws:kms"`: Sử dụng KMS để mã hóa.
            
        * `kms_master_key_id = aws_kms_key.waf_logs_key.arn`: Sử dụng KMS key đã tạo để mã hóa.
            

##### **3.2.7. Tạo FMS Policy**

```bash
resource "aws_fms_policy" "waf_logging_policy" {
  provider              = aws.security
  name                  = var.fms_policy_name
  include_map {
    orgunit = var.fms_policy_orgunit_list
  }
  remediation_enabled   = var.fms_policy_remediation_enabled
  resource_type_list    = ["AWS::WAFv2::WebACL"]
  exclude_resource_tags = var.fms_policy_exclude_resource_tags

  security_service_policy_data {
    type = "WAFV2"

    managed_service_data = jsonencode({
      type = "WAFV2",
      default_action = {
        type = var.fms_policy_default_action
      },
      rule_groups = [],
      logging_configuration = {
        log_destination_configs = [
          var.enable_kms_encryption ? aws_s3_bucket.waf_logs_bucket.arn : aws_s3_bucket.waf_logs_bucket.arn
        ]
      },
      preProcessRuleGroups = [],
      postProcessRuleGroups = []
    })
  }

  # Tagging (nếu cần)
  resource_tags = length(var.fms_policy_resource_tags) == 0 ? null : var.fms_policy_resource_tags
}
```

* `resource "aws_fms_policy" "waf_logging_policy"`: Tạo một FMS Policy để quản lý AWS WAF logging cho các tài khoản workload.
    
* `name`: Tên của FMS Policy, lấy từ biến `fms_policy_name`.
    
* `include_map { orgunit = var.fms_policy_orgunit_list }`: Áp dụng policy cho các Organizational Units được liệt kê trong `fms_policy_orgunit_list`.
    
* `remediation_enabled`: Bật/Tắt remediation tự động khi policy không tuân thủ.
    
* `resource_type_list`: Loại tài nguyên được quản lý bởi policy, ở đây là `AWS::WAFv2::WebACL`.
    
* `exclude_resource_tags`: Các tags để loại trừ trong policy.
    
* `security_service_policy_data`: Cấu hình dịch vụ bảo mật:
    
    * `type = "WAFV2"`: Sử dụng AWS WAF V2.
        
    * `managed_service_data`: Dữ liệu cấu hình được mã hóa JSON:
        
        * `default_action`: Hành động mặc định (`BLOCK` hoặc `ALLOW`).
            
        * `logging_configuration`: Cấu hình logging:
            
            * `log_destination_configs`: Danh sách các đích đến log, ở đây là ARN của S3 bucket.
                
        * `preProcessRuleGroups` và `postProcessRuleGroups`: Các rule group xử lý trước và sau.
            

##### **3.2.8. Tạo Alias Cho KMS Key (Optional)**

```bash
resource "aws_kms_alias" "waf_logs_key_alias" {
  provider = aws.security
  name     = "alias/waf-logs-key"
  target_key_id = aws_kms_key.waf_logs_key.id

  count = var.enable_kms_encryption ? 1 : 0
}
```

* `resource "aws_kms_alias" "waf_logs_key_alias"`: Tạo alias cho KMS key để dễ quản lý.
    
* `name = "alias/waf-logs-key"`: Tên alias.
    
* `target_key_id = aws_kms_key.waf_logs_`[`key.id`](http://key.id): Liên kết alias với KMS key đã tạo.
    
* `count = var.enable_kms_encryption ? 1 : 0`: Chỉ tạo alias nếu `enable_kms_encryption` được bật.
    

#### **3.3. File** [`outputs.tf`](http://outputs.tf)

Cung cấp thông tin về các tài nguyên đã tạo.

```hcl
# security-account/outputs.tf

output "waf_logs_bucket_arn" {
  description = "ARN của S3 bucket để lưu trữ AWS WAF logs"
  value       = aws_s3_bucket.waf_logs_bucket.arn
}

output "kms_key_arn" {
  description = "ARN của KMS key để mã hóa logs (nếu sử dụng)"
  value       = aws_kms_key.waf_logs_key.arn
}

output "fms_policy_arn" {
  description = "ARN của FMS Policy"
  value       = aws_fms_policy.waf_logging_policy.arn
}

output "waf_logs_bucket_name" {
  description = "Tên của S3 bucket để lưu trữ AWS WAF logs"
  value       = aws_s3_bucket.waf_logs_bucket.bucket
}
```

* `output "waf_logs_bucket_arn"`: ARN của S3 bucket.
    
* `output "kms_key_arn"`: ARN của KMS key (nếu sử dụng).
    
* `output "fms_policy_arn"`: ARN của FMS Policy.
    
* `output "waf_logs_bucket_name"`: Tên của S3 bucket.
    

#### **3.4. File** `terraform.tfvars`

Cung cấp giá trị cho các biến đã định nghĩa.

```bash
# security-account/terraform.tfvars

region                  = "ap-southeast-1"
waf_logs_bucket_name    = "aws-waf-logs-centralized"
workload_account_ids    = ["111111111111", "222222222222"] # Thay thế bằng Account IDs thực tế
fms_policy_orgunit_list = ["OU-Workload"] # Thay đổi theo cấu trúc tổ chức bằng OUs
fms_policy_default_action = "BLOCK" # Hoặc "ALLOW"
enable_kms_encryption   = true # Bật nếu bạn muốn sử dụng KMS để mã hóa log
```

* `region`: Vùng AWS.
    
* `waf_logs_bucket_name`: Tên S3 bucket để lưu trữ log.
    
* `workload_account_ids`: Danh sách các Account IDs của các tài khoản workload.
    
* `fms_policy_orgunit_list`: Danh sách các Organizational Units mà FMS Policy áp dụng.
    
* `fms_policy_default_action`: Hành động mặc định (`BLOCK` hoặc `ALLOW`).
    
* `enable_kms_encryption`: Bật/Tắt mã hóa với KMS cho S3 bucket.
    

### **4\. Triển Khai Terraform Trong Security-Account**

#### **4.1. Khởi Tạo Terraform**

```bash
cd security-account
terraform init
```

* `terraform init`: Khởi tạo Terraform, tải các plugin cần thiết.
    

#### **4.2. Kiểm Tra Cấu Hình**

```bash
terraform plan
```

* `terraform plan`: Xem trước các thay đổi sẽ được áp dụng.
    

#### **4.3. Áp Dụng Cấu Hình**

```bash
terraform apply
```

* `terraform apply`: Áp dụng cấu hình, tạo các tài nguyên đã định nghĩa.
    

### **5\. Cấu Hình AWS Firewall Manager (FMS)**

Sau khi triển khai Terraform, AWS Firewall Manager sẽ tự động áp dụng **FMS Policy** cho các tài khoản workload đã được quản lý. Điều này đảm bảo rằng AWS WAF trong các tài khoản workload sẽ gửi log về S3 bucket tập trung đã được cấu hình.

### **6\. Xác Minh và Kiểm Tra**

1. **Kiểm Tra S3 Bucket:**
    
    * Đảm bảo rằng S3 bucket đã được tạo trong security-account và có policy bucket chính xác.
        
    * Kiểm tra rằng bucket đã được cấu hình mã hóa nếu bạn đã bật KMS encryption.
        
2. **Kiểm Tra FMS Policy:**
    
    * Đảm bảo rằng FMS policy đã được tạo và áp dụng cho các tài khoản workload.
        
    * Kiểm tra trong AWS Firewall Manager rằng các tài khoản workload được quản lý và tuân thủ policy.
        
3. **Kiểm Tra AWS WAF Logging:**
    
    * Trong các tài khoản workload, AWS WAF sẽ tự động gửi log về S3 bucket tập trung.
        
    * Kiểm tra S3 bucket để đảm bảo rằng log mới được ghi vào.
        

### **7\. Xử Lý Lỗi Thường Gặp**

Nếu bạn gặp lỗi như:

```
WAFLogDestinationPermissionIssueException: Unable to deliver logs to the configured destination. You might need to grant log delivery permissions for the destination. If you're using S3 as your log destination, you might have exceeded your bucket limit.
```

**Hãy kiểm tra các bước sau:**

1. **policy Bucket:**
    
    * Đảm bảo rằng policy S3 bucket đã được cấu hình chính xác như ở **3.2.4**.
        
    * Đảm bảo rằng `workload_account_ids` trong `terraform.tfvars` đã được thiết lập đúng.
        
2. **Account ID và ARN:**
    
    * Đảm bảo rằng các `aws:SourceAccount` và `aws:SourceArn` trong policy bucket đúng với các tài khoản workload.
        
    * Kiểm tra lại `region` trong `terraform.tfvars` và các ARN được tạo ra.
        
3. **Quyền truy cập KMS:**
    
    * Nếu bạn sử dụng KMS, đảm bảo rằng policy KMS key đã được thiết lập đúng trong **3.2.5**.
        
4. **Giới hạn Bucket:**
    
    * Kiểm tra xem bucket đã đạt giới hạn số lượng log hay chưa. Nếu cần, tăng giới hạn hoặc tạo thêm bucket.
        
5. **Region:**
    
    * Đảm bảo rằng bạn đang sử dụng đúng region cho cả S3 bucket và AWS WAF.
        
6. **AWS CLI:**
    
    * Đảm bảo rằng bạn đang sử dụng phiên bản AWS CLI mới nhất.
        

### **8\. Mẫu Terraform Đầy Đủ với Giải Thích Chi Tiết**

Dưới đây là mẫu Terraform hoàn chỉnh cho **security-account** với các giải thích chi tiết.

#### **8.1.** [`main.tf`](http://main.tf)

```bash
# security-account/main.tf

provider "aws" {
  alias  = "security"
  region = var.region
}

data "aws_caller_identity" "current" {}

# Tạo S3 Bucket để lưu trữ WAF logs
resource "aws_s3_bucket" "waf_logs_bucket" {
  provider = aws.security
  bucket   = var.waf_logs_bucket_name
  acl      = "private"

  tags = {
    Name        = "AWS WAF Logs Centralized Bucket"
    Environment = "Security"
  }
}

# policy bucket để cho phép AWS WAF từ các tài khoản workload ghi log
resource "aws_s3_bucket_policy" "waf_logs_bucket_policy" {
  provider = aws.security
  bucket   = aws_s3_bucket.waf_logs_bucket.id

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "AWSLogDeliveryWrite",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = "s3:PutObject",
        Resource = "${aws_s3_bucket.waf_logs_bucket.arn}/AWSLogs/*",
        Condition = {
          StringEquals = {
            "s3:x-amz-acl"      = "bucket-owner-full-control",
            "aws:SourceAccount" = var.workload_account_ids
          },
          ArnLike = {
            "aws:SourceArn" = [
              for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
            ]
          }
        }
      },
      {
        Sid       = "AWSLogDeliveryAclCheck",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = "s3:GetBucketAcl",
        Resource = aws_s3_bucket.waf_logs_bucket.arn,
        Condition = {
          StringEquals = {
            "aws:SourceAccount" = var.workload_account_ids
          },
          ArnLike = {
            "aws:SourceArn" = [
              for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
            ]
          }
        }
      }
    ]
  })
}

# (Tùy chọn) Tạo KMS Key để mã hóa log
resource "aws_kms_key" "waf_logs_key" {
  provider = aws.security
  description             = "KMS key for encrypting AWS WAF logs"
  deletion_window_in_days = 30
  enable_key_rotation     = true

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "Allow administration of the key",
        Effect    = "Allow",
        Principal = {
          AWS = "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
        },
        Action   = [
          "kms:Create*",
          "kms:Describe*",
          "kms:Enable*",
          "kms:List*",
          "kms:Put*",
          "kms:Update*",
          "kms:Revoke*",
          "kms:Disable*",
          "kms:Get*",
          "kms:Delete*",
          "kms:TagResource",
          "kms:UntagResource",
          "kms:ScheduleKeyDeletion",
          "kms:CancelKeyDeletion"
        ],
        Resource = "*"
      },
      {
        Sid       = "Allow AWS WAF to use the key",
        Effect    = "Allow",
        Principal = {
          Service = "delivery.logs.amazonaws.com"
        },
        Action   = [
          "kms:GenerateDataKey*",
          "kms:Decrypt"
        ],
        Resource = "*"
      }
    ]
  })
}

# Cấu hình mã hóa cho S3 bucket (nếu bật KMS encryption)
resource "aws_s3_bucket_server_side_encryption_configuration" "waf_logs_sse" {
  provider = aws.security
  bucket   = aws_s3_bucket.waf_logs_bucket.id

  dynamic "rule" {
    for_each = var.enable_kms_encryption ? [1] : []
    content {
      apply_server_side_encryption_by_default {
        sse_algorithm     = "aws:kms"
        kms_master_key_id = aws_kms_key.waf_logs_key.arn
      }
    }
  }
}

# Tạo FMS Policy để cấu hình logging cho WAF trong các tài khoản workload
resource "aws_fms_policy" "waf_logging_policy" {
  provider              = aws.security
  name                  = var.fms_policy_name
  include_map {
    orgunit = var.fms_policy_orgunit_list
  }
  remediation_enabled   = var.fms_policy_remediation_enabled
  resource_type_list    = ["AWS::WAFv2::WebACL"]
  exclude_resource_tags = var.fms_policy_exclude_resource_tags

  security_service_policy_data {
    type = "WAFV2"

    managed_service_data = jsonencode({
      type = "WAFV2",
      default_action = {
        type = var.fms_policy_default_action
      },
      rule_groups = [],
      logging_configuration = {
        log_destination_configs = [
          aws_s3_bucket.waf_logs_bucket.arn
        ]
      },
      preProcessRuleGroups = [],
      postProcessRuleGroups = []
    })
  }

  # Tagging (nếu cần)
  resource_tags = length(var.fms_policy_resource_tags) == 0 ? null : var.fms_policy_resource_tags
}

# (Nếu bạn sử dụng AWS KMS để mã hóa log, tạo alias cho KMS key
resource "aws_kms_alias" "waf_logs_key_alias" {
  provider = aws.security
  name     = "alias/waf-logs-key"
  target_key_id = aws_kms_key.waf_logs_key.id

  count = var.enable_kms_encryption ? 1 : 0
}
```

##### **Giải Thích Chi Tiết** [`main.tf`](http://main.tf)

1. **Provider Configuration:**
    
    ```bash
    provider "aws" {
      alias  = "security"
      region = var.region
    }
    ```
    
    * Định nghĩa provider AWS với alias `security`, sử dụng vùng được chỉ định trong biến `region`.
        
2. **Data Source:**
    
    ```bash
    data "aws_caller_identity" "current" {}
    ```
    
    * Lấy thông tin về tài khoản AWS hiện tại (security-account), sử dụng để tham chiếu trong các tài nguyên khác.
        
3. **Tạo S3 Bucket:**
    
    ```bash
    resource "aws_s3_bucket" "waf_logs_bucket" {
      provider = aws.security
      bucket   = var.waf_logs_bucket_name
      acl      = "private"
    
      tags = {
        Name        = "AWS WAF Logs Centralized Bucket"
        Environment = "Security"
      }
    }
    ```
    
    * Tạo một S3 bucket với tên được lấy từ biến `waf_logs_bucket_name`.
        
    * Quyền truy cập bucket là riêng tư (`private`).
        
    * Thêm thẻ để dễ quản lý và nhận diện.
        
4. **Thiết Lập policy Bucket:**
    
    ```bash
    resource "aws_s3_bucket_policy" "waf_logs_bucket_policy" {
      provider = aws.security
      bucket   = aws_s3_bucket.waf_logs_bucket.id
    
      policy = jsonencode({
        Version = "2012-10-17",
        Statement = [
          {
            Sid       = "AWSLogDeliveryWrite",
            Effect    = "Allow",
            Principal = {
              Service = "delivery.logs.amazonaws.com"
            },
            Action   = "s3:PutObject",
            Resource = "${aws_s3_bucket.waf_logs_bucket.arn}/AWSLogs/*",
            Condition = {
              StringEquals = {
                "s3:x-amz-acl"      = "bucket-owner-full-control",
                "aws:SourceAccount" = var.workload_account_ids
              },
              ArnLike = {
                "aws:SourceArn" = [
                  for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
                ]
              }
            }
          },
          {
            Sid       = "AWSLogDeliveryAclCheck",
            Effect    = "Allow",
            Principal = {
              Service = "delivery.logs.amazonaws.com"
            },
            Action   = "s3:GetBucketAcl",
            Resource = aws_s3_bucket.waf_logs_bucket.arn,
            Condition = {
              StringEquals = {
                "aws:SourceAccount" = var.workload_account_ids
              },
              ArnLike = {
                "aws:SourceArn" = [
                  for acct_id in var.workload_account_ids : "arn:aws:logs:${var.region}:${acct_id}:*"
                ]
              }
            }
          }
        ]
      })
    }
    ```
    
    * **Statement 1: AWSLogDeliveryWrite**
        
        * `Effect = "Allow"`: Cho phép hành động.
            
        * `Principal = { Service = "`[`delivery.logs.amazonaws.com`](http://delivery.logs.amazonaws.com)`" }`: Cho phép dịch vụ AWS Logs Delivery.
            
        * `Action = "s3:PutObject"`: Cho phép ghi đối tượng vào bucket.
            
        * `Resource = "${aws_s3_bucket.waf_logs_bucket.arn}/AWSLogs/*"`: Chỉ cho phép ghi vào thư mục `AWSLogs` trong bucket.
            
        * `Condition`:
            
            * `StringEquals`:
                
                * `"s3:x-amz-acl" = "bucket-owner-full-control"`: Yêu cầu quyền sở hữu đầy đủ cho bucket owner.
                    
                * `"aws:SourceAccount" = var.workload_account_ids`: Giới hạn các tài khoản workload được phép ghi log.
                    
            * `ArnLike`:
                
                * `"aws:SourceArn" = "arn:aws:logs:${var.region}:${acct_id}:*"`: Giới hạn các ARN log từ các tài khoản workload trong vùng cụ thể.
                    
    * **Statement 2: AWSLogDeliveryAclCheck**
        
        * `Effect = "Allow"`: Cho phép hành động.
            
        * `Principal = { Service = "`[`delivery.logs.amazonaws.com`](http://delivery.logs.amazonaws.com)`" }`: Cho phép dịch vụ AWS Logs Delivery.
            
        * `Action = "s3:GetBucketAcl"`: Cho phép lấy ACL của bucket.
            
        * `Resource = aws_s3_bucket.waf_logs_bucket.arn`: Chỉ định bucket cụ thể.
            
        * `Condition`:
            
            * `StringEquals`:
                
                * `"aws:SourceAccount" = var.workload_account_ids`: Giới hạn các tài khoản workload được phép truy cập.
                    
            * `ArnLike`:
                
                * `"aws:SourceArn" = "arn:aws:logs:${var.region}:${acct_id}:*"`: Giới hạn các ARN log từ các tài khoản workload trong vùng cụ thể.
                    
5. **Tạo KMS Key (Tùy chọn):**
    
    * `resource "aws_kms_key" "waf_logs_key"`: Tạo một KMS key để mã hóa log WAF.
        
    * `policy`: policy cho phép quản trị key bởi root user và dịch vụ [`delivery.logs.amazonaws.com`](http://delivery.logs.amazonaws.com) sử dụng key để mã hóa và giải mã log.
        
6. **Cấu Hình Mã Hóa Cho S3 Bucket (Tùy chọn):**
    
    * `resource "aws_s3_bucket_server_side_encryption_configuration" "waf_logs_sse"`: Thiết lập mã hóa phía server cho S3 bucket nếu `enable_kms_encryption` được bật.
        
    * Sử dụng **dynamic block** để thêm rule mã hóa chỉ khi `enable_kms_encryption` là `true`.
        
7. **Tạo FMS Policy:**
    
    * `resource "aws_fms_policy" "waf_logging_policy"`: Tạo FMS Policy để quản lý AWS WAF logging cho các tài khoản workload.
        
    * `include_map { orgunit = var.fms_policy_orgunit_list }`: Áp dụng policy cho các Organizational Units cụ thể.
        
    * `security_service_policy_data`: Cấu hình dịch vụ bảo mật:
        
        * `type = "WAFV2"`: Sử dụng AWS WAF V2.
            
        * `managed_service_data`: Dữ liệu cấu hình được mã hóa JSON:
            
            * `default_action`: Hành động mặc định (`BLOCK` hoặc `ALLOW`).
                
            * `logging_configuration`: Cấu hình logging:
                
                * `log_destination_configs`: ARN của S3 bucket để gửi log.
                    
            * `preProcessRuleGroups` và `postProcessRuleGroups`: Các rule group xử lý trước và sau.
                
8. **Tạo Alias Cho KMS Key (Tùy chọn):**
    
    * `resource "aws_kms_alias" "waf_logs_key_alias"`: Tạo alias cho KMS key để dễ quản lý.
        
    * `count = var.enable_kms_encryption ? 1 : 0`: Chỉ tạo alias nếu `enable_kms_encryption` được bật.
        

#### **8.2.** [`outputs.tf`](http://outputs.tf)

```bash
# security-account/outputs.tf

output "waf_logs_bucket_arn" {
  description = "ARN của S3 bucket để lưu trữ AWS WAF logs"
  value       = aws_s3_bucket.waf_logs_bucket.arn
}

output "kms_key_arn" {
  description = "ARN của KMS key để mã hóa logs (nếu sử dụng)"
  value       = aws_kms_key.waf_logs_key.arn
}

output "fms_policy_arn" {
  description = "ARN của FMS Policy"
  value       = aws_fms_policy.waf_logging_policy.arn
}

output "waf_logs_bucket_name" {
  description = "Tên của S3 bucket để lưu trữ AWS WAF logs"
  value       = aws_s3_bucket.waf_logs_bucket.bucket
}
```

* `output "waf_logs_bucket_arn"`: Cung cấp ARN của S3 bucket để sử dụng trong các tài nguyên khác hoặc kiểm tra.
    
* `output "kms_key_arn"`: Cung cấp ARN của KMS key nếu sử dụng mã hóa.
    
* `output "fms_policy_arn"`: Cung cấp ARN của FMS Policy để quản lý hoặc tham khảo.
    
* `output "waf_logs_bucket_name"`: Cung cấp tên của S3 bucket.
    

#### **8.3.** `terraform.tfvars`

```bash
# security-account/terraform.tfvars

region                   = "ap-southeast-1"
waf_logs_bucket_name     = "aws-waf-logs-centralized"
workload_account_ids     = ["111111111111", "222222222222"] # Thay thế bằng Account IDs thực tế
fms_policy_orgunit_list  = ["OU-Workload"] # Thay đổi theo cấu trúc tổ chức của bạn
fms_policy_default_action = "BLOCK" # Hoặc "ALLOW"
enable_kms_encryption    = true # Bật nếu bạn muốn sử dụng KMS để mã hóa log
fms_policy_resource_tags = {
  Project = "WAFLogging"
}
```

* `region`: Region AWS bạn muốn triển khai.
    
* `waf_logs_bucket_name`: Tên S3 bucket để lưu trữ log.
    
* `workload_account_ids`: Danh sách các Account IDs của các tài khoản workload.
    
* `fms_policy_orgunit_list`: Danh sách các Organizational Units mà FMS Policy áp dụng.
    
* `fms_policy_default_action`: Hành động mặc định của FMS Policy (`BLOCK` hoặc `ALLOW`).
    
* `enable_kms_encryption`: Bật (`true`) hoặc tắt (`false`) mã hóa với KMS cho S3 bucket.
    
* `fms_policy_resource_tags`: Tags áp dụng cho FMS Policy (nếu cần).
    

### **9\. Deploy terraform trong Security-Account**

#### **9.1. Init Terraform**

```bash
cd security-account
terraform init
```

* `terraform init`: Khởi tạo Terraform, tải các plugin cần thiết.
    

#### **9.2. Check plan**

```bash
terraform plan
```

* `terraform plan`: Xem trước các thay đổi sẽ được áp dụng. Đảm bảo rằng tất cả các tài nguyên được cấu hình đúng như mong muốn.
    

#### **9.3. Apply**

```bash
terraform apply
```

* `terraform apply`: Áp dụng cấu hình, tạo các tài nguyên đã định nghĩa.
    

### **10\. Verify**

1. **Kiểm Tra S3 Bucket:**
    
    * Đảm bảo rằng S3 bucket đã được tạo trong security-account và có policy bucket chính xác.
        
    * Kiểm tra rằng bucket đã được cấu hình mã hóa nếu bạn đã bật KMS encryption.
        
2. **Kiểm Tra FMS Policy:**
    
    * Đảm bảo rằng FMS policy đã được tạo và áp dụng cho các tài khoản workload.
        
    * Kiểm tra trong AWS Firewall Manager rằng các tài khoản workload được quản lý và tuân thủ policy.
        
3. **Kiểm Tra AWS WAF Logging:**
    
    * Trong các tài khoản workload, AWS WAF sẽ tự động gửi log về S3 bucket tập trung.
        
    * Kiểm tra S3 bucket để đảm bảo rằng log mới được ghi vào.
        

### **11\. Xử lý lỗi có thể gặp**

Nếu bạn gặp lỗi như:

```bash
WAFLogDestinationPermissionIssueException: Unable to deliver logs to the configured destination. You might need to grant log delivery permissions for the destination. If you're using S3 as your log destination, you might have exceeded your bucket limit.
```

**Hãy kiểm tra các bước sau:**

1. **policy Bucket:**
    
    * Đảm bảo rằng policy S3 bucket đã được cấu hình chính xác như ở **3.2.4**.
        
    * Đảm bảo rằng `workload_account_ids` trong `terraform.tfvars` đã được thiết lập đúng.
        
2. **Account ID và ARN:**
    
    * Đảm bảo rằng các `aws:SourceAccount` và `aws:SourceArn` trong policy bucket đúng với các tài khoản workload.
        
    * Kiểm tra lại `region` trong `terraform.tfvars` và các ARN được tạo ra.
        
3. **Quyền truy cập KMS:**
    
    * Nếu bạn sử dụng KMS, đảm bảo rằng policy KMS key đã được thiết lập đúng trong **3.2.5**.
        
4. **Giới hạn Bucket:**
    
    * Kiểm tra xem bucket đã đạt giới hạn số lượng log hay chưa. Nếu cần, tăng giới hạn hoặc tạo thêm bucket.
        
5. **Region:**
    
    * Đảm bảo rằng bạn đang sử dụng đúng region cho cả S3 bucket và AWS WAF.
        
6. **AWS CLI:**
    
    * Đảm bảo rằng bạn đang sử dụng phiên bản AWS CLI mới nhất.